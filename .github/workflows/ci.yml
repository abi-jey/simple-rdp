name: CI

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to PyPI'
        required: false
        default: false
        type: boolean
      version_bump:
        description: 'Version bump type (requires publish)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major

jobs:
  # =============================================================================
  # LINT
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Install pre-commit
        run: pip install pre-commit
      
      - name: Run pre-commit
        run: pre-commit run --all-files

  # =============================================================================
  # LINUX - Test & Build
  # =============================================================================
  linux:
    name: Linux (${{ matrix.target }}, py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, aarch64]
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i ${{ matrix.python-version }}
          sccache: true
          manylinux: auto
      
      # Only run tests on x86_64 (native architecture)
      - name: Install wheel and test
        if: matrix.target == 'x86_64'
        run: |
          pip install dist/*.whl
          python -c "from simple_rdp._rle import decompress_rle; print('Rust extension works')"
          pip install pytest pytest-asyncio pytest-cov pyspnego pyasn1 pillow asn1crypto python-dotenv
          cp -r tests /tmp/tests
          cd /tmp
          pytest tests/ --ignore=tests/e2e -v --cov=simple_rdp --cov-report=xml --cov-report=term-missing
          cp coverage.xml $GITHUB_WORKSPACE/coverage.xml
      
      - name: Upload coverage
        if: matrix.python-version == '3.12' && matrix.target == 'x86_64'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
      
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}-py${{ matrix.python-version }}
          path: dist

  # =============================================================================
  # WINDOWS - Test & Build
  # =============================================================================
  windows:
    name: Windows (py${{ matrix.python-version }})
    runs-on: windows-latest
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist -i ${{ matrix.python-version }}
          sccache: true
      
      - name: Install wheel and test
        shell: bash
        run: |
          pip install dist/*.whl
          python -c "from simple_rdp._rle import decompress_rle; print('Rust extension works')"
          pip install pytest pytest-asyncio pytest-cov pyspnego pyasn1 pillow asn1crypto python-dotenv
          cp -r tests /tmp/tests
          cd /tmp
          pytest tests/ --ignore=tests/e2e -v
      
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-x64-py${{ matrix.python-version }}
          path: dist

  # =============================================================================
  # MACOS - Test & Build
  # =============================================================================
  macos:
    name: macOS (${{ matrix.target }}, py${{ matrix.python-version }})
    runs-on: macos-latest
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, aarch64]
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i ${{ matrix.python-version }}
          sccache: true
      
      # Only run tests on native architecture (aarch64 on macos-latest)
      - name: Install wheel and test
        if: matrix.target == 'aarch64'
        run: |
          pip install dist/*.whl
          python -c "from simple_rdp._rle import decompress_rle; print('Rust extension works')"
          pip install pytest pytest-asyncio pytest-cov pyspnego pyasn1 pillow asn1crypto python-dotenv
          cp -r tests /tmp/tests
          cd /tmp
          pytest tests/ --ignore=tests/e2e -v
      
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}-py${{ matrix.python-version }}
          path: dist

  # =============================================================================
  # SOURCE DISTRIBUTION
  # =============================================================================
  sdist:
    name: Source Distribution
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist

  # =============================================================================
  # PUBLISH (Stable Release)
  # =============================================================================
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [linux, windows, macos, sdist]
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'workflow_dispatch' && inputs.publish)
    environment:
      name: pypi
      url: https://pypi.org/project/simple-rdp/
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install toml
      
      - name: Bump version (if requested)
        id: bump
        if: github.event_name == 'workflow_dispatch' && inputs.version_bump != 'none'
        run: |
          import toml
          import os
          
          bump_type = "${{ inputs.version_bump }}"
          
          with open('pyproject.toml', 'r') as f:
              config = toml.load(f)
          
          current = config['project']['version']
          parts = current.split('.')
          major, minor, patch = int(parts[0]), int(parts[1]), int(parts[2].split('-')[0].split('.dev')[0])
          
          if bump_type == 'major':
              major += 1
              minor = 0
              patch = 0
          elif bump_type == 'minor':
              minor += 1
              patch = 0
          elif bump_type == 'patch':
              patch += 1
          
          new_version = f"{major}.{minor}.{patch}"
          
          config['project']['version'] = new_version
          with open('pyproject.toml', 'w') as f:
              toml.dump(config, f)
          
          with open('Cargo.toml', 'r') as f:
              cargo = toml.load(f)
          cargo['package']['version'] = new_version
          with open('Cargo.toml', 'w') as f:
              toml.dump(cargo, f)
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"version={new_version}\n")
              f.write(f"bumped=true\n")
          
          print(f"Bumped version: {current} -> {new_version}")
        shell: python
      
      - name: Get current version
        id: version
        if: steps.bump.outputs.bumped != 'true'
        run: |
          import toml
          import os
          
          with open('pyproject.toml', 'r') as f:
              config = toml.load(f)
          
          version = config['project']['version']
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"version={version}\n")
          
          print(f"Current version: {version}")
        shell: python
      
      - name: Commit version bump
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pyproject.toml Cargo.toml
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git pull --rebase origin main
          git push
      
      # When version is bumped, we need to rebuild wheels with new version
      - name: Setup Rust
        if: steps.bump.outputs.bumped == 'true'
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build all wheels with new version
        if: steps.bump.outputs.bumped == 'true'
        uses: PyO3/maturin-action@v1
        with:
          args: --release --out dist
      
      - name: Download pre-built artifacts
        if: steps.bump.outputs.bumped != 'true'
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheels-*
          merge-multiple: true
      
      - name: List artifacts
        run: ls -la dist/
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true
      
      - name: Get previous stable tag
        id: prev_tag
        run: |
          # Get stable tags (exclude dev/alpha/beta)
          PREV_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -2 | tail -1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous stable tag: $PREV_TAG"
      
      - name: Generate release notes
        run: |
          VERSION="${{ steps.bump.outputs.version || steps.version.outputs.version }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          
          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md
          
          git log ${PREV_TAG}..HEAD --pretty=format:"* %s (%h)" --no-merges >> release_notes.md
          
          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${VERSION}" >> release_notes.md
          
          cat release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version || steps.version.outputs.version }}
          name: v${{ steps.bump.outputs.version || steps.version.outputs.version }}
          body_path: release_notes.md
          files: dist/*

  # =============================================================================
  # DEV RELEASE (on main branch push)
  # =============================================================================
  publish-dev:
    name: Publish Dev
    runs-on: ubuntu-latest
    needs: [linux, windows, macos, sdist]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: pypi
      url: https://pypi.org/project/simple-rdp/
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: pip install maturin toml
      
      - name: Generate dev version
        id: version
        run: |
          import toml
          import os
          from datetime import datetime
          
          with open('pyproject.toml', 'r') as f:
              config = toml.load(f)
          
          base_version = config['project']['version']
          timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
          
          python_version = f"{base_version}.dev{timestamp}"
          cargo_version = f"{base_version}-dev.{timestamp}"
          
          config['project']['version'] = python_version
          with open('pyproject.toml', 'w') as f:
              toml.dump(config, f)
          
          with open('Cargo.toml', 'r') as f:
              cargo = toml.load(f)
          cargo['package']['version'] = cargo_version
          with open('Cargo.toml', 'w') as f:
              toml.dump(cargo, f)
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"version={python_version}\n")
          
          print(f"Dev version: {python_version}")
        shell: python
      
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          args: --release --out dist
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-all
          pattern: wheels-*
          merge-multiple: true
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-all/
          skip-existing: true
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Dev v${{ steps.version.outputs.version }}
          prerelease: true
          generate_release_notes: true
          files: dist-all/*
